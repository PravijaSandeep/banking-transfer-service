<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractTransferServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Money Transfer Service</a> &gt; <a href="index.source.html" class="el_package">com.exercise.banking.service.transfer.money.service.impl</a> &gt; <span class="el_source">AbstractTransferServiceImpl.java</span></div><h1>AbstractTransferServiceImpl.java</h1><pre class="source lang-java linenums">package com.exercise.banking.service.transfer.money.service.impl;

import java.math.BigDecimal;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.transaction.annotation.Isolation;
import org.springframework.transaction.annotation.Transactional;

import com.exercise.banking.service.transfer.money.dto.TransferRequest;
import com.exercise.banking.service.transfer.money.dto.TransferResponse;
import com.exercise.banking.service.transfer.money.exception.AccountNotFoundException;
import com.exercise.banking.service.transfer.money.exception.InsufficientFundsException;
import com.exercise.banking.service.transfer.money.exception.TransactionProcessingException;
import com.exercise.banking.service.transfer.money.model.Account;
import com.exercise.banking.service.transfer.money.model.Payee;
import com.exercise.banking.service.transfer.money.model.Transaction;
import com.exercise.banking.service.transfer.money.model.TransactionStatus;
import com.exercise.banking.service.transfer.money.model.TransferType;
import com.exercise.banking.service.transfer.money.repository.AccountRepository;
import com.exercise.banking.service.transfer.money.repository.TransactionRepository;
import com.exercise.banking.service.transfer.money.service.AccountService;
import com.exercise.banking.service.transfer.money.service.TransferService;
/**
 * Abstract Service implementation for Transfer.
 * 
 */

public abstract class AbstractTransferServiceImpl implements TransferService {

<span class="fc" id="L31">    private static final Logger logger = LoggerFactory.getLogger(AbstractTransferServiceImpl.class);</span>

    protected final AccountRepository accountRepository;
    protected final TransactionRepository txnRepository;
    protected final AccountService accountService;

<span class="fc" id="L37">    protected AbstractTransferServiceImpl(AccountRepository accountRepository, TransactionRepository txnRepository, AccountService accountService) {</span>
<span class="fc" id="L38">        this.accountRepository = accountRepository;</span>
<span class="fc" id="L39">        this.txnRepository = txnRepository;</span>
<span class="fc" id="L40">        this.accountService = accountService;</span>
<span class="fc" id="L41">    }</span>

    @Override
    @Transactional(isolation = Isolation.SERIALIZABLE)
    public TransferResponse performTransfer(TransferRequest request) {
<span class="fc" id="L46">        logger.info(&quot;Started processing transfer for request: {}&quot;, request);</span>
<span class="fc" id="L47">        Account payerAccount = findPayerAccount(request);</span>
<span class="fc" id="L48">        validateRequest(request, payerAccount);</span>
<span class="fc" id="L49">        Payee payee = findRegisteredPayee(request);</span>
<span class="fc" id="L50">        Transaction txn = executeTransfer(payerAccount, request.getPayeeAccNumber(), request.getAmount(), payee);</span>
<span class="fc" id="L51">        return sendResponse(txn);</span>
    }

    /**
     * Validate the request parameters
     *
     * @param request
     * @param payerAccount
     */
    private void validateRequest(TransferRequest request, Account payerAccount) {
<span class="fc bfc" id="L61" title="All 2 branches covered.">        if (request.getPayerAccNumber().equals(request.getPayeeAccNumber())) {</span>
<span class="fc" id="L62">            throw new IllegalArgumentException(&quot;Payer and payee accounts cannot be the same.&quot;);</span>
        }
<span class="fc" id="L64">        checkBalance(request, payerAccount);</span>
<span class="fc" id="L65">    }</span>

    /**
     * Check if the payer account has enough balance to proceed with transfer
     *
     * @param request
     * @param payerAccount
     */
    private void checkBalance(TransferRequest request, Account payerAccount) {
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (payerAccount.getBalance().compareTo(request.getAmount()) &lt; 0) {</span>
<span class="fc" id="L75">            logger.error(&quot;Transfer failed: Payer account has insufficient funds. Account balance is {}&quot;, payerAccount.getBalance());</span>
<span class="fc" id="L76">            throw new InsufficientFundsException(&quot;Insufficient funds in account&quot;);</span>
        }
<span class="fc" id="L78">    }</span>

    /**
     * Find and returns the registered Payee for the Payer account
     *
     * @param request
     * @return registered payee
     */
    private Payee findRegisteredPayee(TransferRequest request) {
<span class="fc" id="L87">        logger.info(&quot;Finding the registered Payee with account num {} for Payer Account {}&quot;, request.getPayeeAccNumber(), request.getPayerAccNumber());</span>
<span class="fc" id="L88">        Payee payee = accountService.getPayeeByAccountNumbersOrThrow(request.getPayerAccNumber(), request.getPayeeAccNumber(),request.getPayeeBankCode());</span>
       
<span class="fc" id="L90">        logger.info(&quot;Registered Payee for Payer Account  is {}&quot;, payee.getName());</span>
<span class="fc" id="L91">        return payee;</span>
    }

    /**
     * Finds the Payer account matching to the request
     *
     * @param request
     * @return
     */
    private Account findPayerAccount(TransferRequest request) {
<span class="fc" id="L101">        return accountRepository.findById(request.getPayerAccNumber())</span>
<span class="fc" id="L102">                .orElseThrow(() -&gt; </span>
<span class="fc" id="L103">                     new AccountNotFoundException(&quot;Account not found&quot;)</span>
                );
    }

    /**
     * Persists the transaction.
     *
     * @param payerAccount the payer's account
     * @param payee the payee's account
     * @param amount the amount to transfer
     * @param type the type of transfer (intra-bank or inter-bank)
     * @return the saved Transaction object
     */
    protected Transaction recordTransaction(Account payerAccount, Payee payee, BigDecimal amount, TransferType type) {
<span class="fc" id="L117">        Transaction transaction = createTransaction(payerAccount, payee, amount, type.getValue());</span>

        try {
            // Update the payer account balance
<span class="fc" id="L121">            updatePayerAccountBalance(payerAccount, amount);</span>

            // Save the transaction with status &quot;Success&quot;
<span class="fc" id="L124">            transaction.setStatus(TransactionStatus.SUCCESS);</span>
<span class="fc" id="L125">            transaction = txnRepository.save(transaction);</span>

<span class="fc" id="L127">            logger.info(&quot;Transaction {} recorded successfully&quot;, transaction.getTransactionId());</span>

<span class="fc" id="L129">            return transaction;</span>

<span class="fc" id="L131">        } catch (Exception e) {</span>
            // If any error occurs, log the exception
<span class="fc" id="L133">            logger.error(&quot;Transaction failed due to exception {}&quot;, e.getMessage(), e);</span>

            // Set the transaction status to &quot;Failure&quot;
<span class="fc" id="L136">            transaction.setStatus(TransactionStatus.FAILURE);</span>
<span class="fc" id="L137">            txnRepository.save(transaction); // Save the failed transaction</span>

<span class="fc" id="L139">            throw new TransactionProcessingException(&quot;Error processing transaction&quot;);</span>
        }
    }

    
	protected Transaction createTransaction(Account payerAccount, Payee payee, BigDecimal amount, String type) {
		// Record the transaction
<span class="fc" id="L146">        return new Transaction(</span>
<span class="fc" id="L147">                null,  // ID will be auto-generated</span>
<span class="fc" id="L148">                payerAccount,</span>
<span class="fc" id="L149">                payee,</span>
<span class="fc" id="L150">                amount,</span>
<span class="fc" id="L151">                null,  // Timestamp will be set automatically</span>
<span class="fc" id="L152">                TransactionStatus.PENDING,</span>
<span class="fc" id="L153">                type</span>
               );
	}

    /**
     * Updates Payer Account balance
     * @param payerAccount
     * @param amount
     */
	private synchronized void updatePayerAccountBalance(Account payerAccount, BigDecimal amount) {
<span class="fc" id="L163">		logger.info(&quot;Debiting {} from payer Account with balance: {}&quot;, amount,  payerAccount.getBalance());</span>
<span class="fc" id="L164">        BigDecimal balance = payerAccount.getBalance().subtract(amount);</span>
<span class="fc" id="L165">        logger.info(&quot;Updating balance to '{}'.&quot;, balance);</span>

<span class="fc" id="L167">        payerAccount.setBalance(balance);</span>
<span class="fc" id="L168">        accountRepository.save(payerAccount);</span>
<span class="fc" id="L169">	}</span>
	
	 /**
     * Sends the response for Transfer request.
     *
     * @param payerBalance
     * @param transferredAmount
     * @return
     */
    private TransferResponse sendResponse(Transaction txn) {
        
<span class="fc" id="L180">    	return new TransferResponse(</span>
<span class="fc" id="L181">    			 txn.getTransactionId(),               // transactionId</span>
<span class="fc" id="L182">    			 txn.getStatus().name(),                  // status</span>
<span class="fc" id="L183">    			 txn.getPayerAccount().getBalance(),  // balance</span>
<span class="fc" id="L184">    			 txn.getAmount(),</span>
<span class="fc" id="L185">    			 txn.getType()// transferType</span>
         	);

    }

    /**
     * Executes the transfer to Payee account.
     *
     * @param payerAccount
     * @param payeeAccountNum
     * @param amount
     * @param payee
     * @return TransferResponse
     * @throws AccountNotFoundException
     */
    protected abstract Transaction executeTransfer(Account payerAccount, String payeeAccountNum, BigDecimal amount, Payee payee) throws AccountNotFoundException;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>